{% extends "base.jinja" %}
{% block title %}Frekwencja{% endblock %}
{% block page_title %}Frekwencja{% endblock %}
{% block content %}
<form method="get" class="mb-3">
  <div class="row g-3 align-items-center mb-4">
    <div class="col-12 col-lg-auto">
      <label for="season" class="col-form-label">Sezon:</label>
    </div>
    <div class="col-12 col-lg-auto">
      <select name="season" id="season" class="form-select" onchange="this.form.submit()">
        {% if seasons %}
          {% for season in seasons %}
            <option value="{{ season.id }}" {% if season == selected_season %}selected{% endif %}>
              {{ season.name }}
              {% if season == current_season %}(aktywny){% endif %}
            </option>
          {% endfor %}
        {% else %}
          <option value="" disabled selected>Brak sezon√≥w</option>
        {% endif %}
      </select>
    </div>
    <div class="col-12 col-lg-auto">
      <label for="event_type" class="col-form-label">Typ wydarzenia:</label>
    </div>
    <div class="col-12 col-lg-auto">
      <select name="event_type" id="event_type" class="form-select" onchange="this.form.submit()">
        <option value="all" {% if event_type == 'all' %}selected{% endif %}>Wszystkie</option>
        <option value="concert" {% if event_type == 'concert' %}selected{% endif %}>Koncert</option>
        <option value="rehearsal" {% if event_type == 'rehearsal' %}selected{% endif %}>Pr√≥ba</option>
        <option value="soundcheck" {% if event_type == 'soundcheck' %}selected{% endif %}>Soundcheck</option>
      </select>
    </div>
    <div class="col-12 col-lg-auto ms-lg-auto">
      <div class="d-flex gap-2">
        {% if can_check %}
          <a href="{% url 'add_attendance' %}?event_type={{ event_type }}" class="btn btn-primary">Dodaj frekwencjƒô</a>
        {% endif %}
        {% if can_manage_seasons %}
          <a href="{% url 'manage_seasons' %}" class="btn btn-outline-secondary">ZarzƒÖdzaj sezonami</a>
        {% endif %}
      </div>
    </div>
  </div>
</form>

{% if selected_season %}
  <div class="alert alert-success mb-3">
    <strong>üìÖ Wybrany sezon:</strong> Wy≈õwietlane sƒÖ wydarzenia z sezonu <strong>{{ selected_season.name }}</strong>
    {% if selected_season == current_season %} (aktywny sezon){% endif %}.
  </div>
{% elif not seasons %}
  <div class="alert alert-warning mb-3">
    <strong>‚ö†Ô∏è Brak sezon√≥w:</strong> Nie ma ≈ºadnych sezon√≥w w systemie. 
    {% if can_manage_seasons %}
      <a href="{% url 'add_season' %}" class="alert-link">Dodaj pierwszy sezon</a>.
    {% endif %}
  </div>
{% endif %}

<div class="table-responsive">
  <table class="table table-bordered align-middle">
    <thead class="table-light">
      <tr>
        <th scope="col" class="text-center align-middle user-column">U≈ºytkownik</th>
        {% for event in events %}
          <th scope="col" class="text-center align-middle">
            <div class="d-flex flex-column justify-content-center">
              {% if event.type == 'concert' %}
                <span class="badge bg-success mb-1">üéµ Koncert</span>
              {% elif event.type == 'rehearsal' %}
                <span class="badge bg-warning mb-1">üéº Pr√≥ba</span>
              {% elif event.type == 'soundcheck' %}
                <span class="badge bg-info mb-1">üîä Soundcheck</span>
              {% else %}
                <span class="badge bg-secondary mb-1">{{ event.type|title }}</span>
              {% endif %}
              <span class="fw-bold">{{ event.name }}</span>
              <small class="text-muted">{{ event.date }}</small>
              {% if can_check or can_delete %}
                <div class="btn-group mt-1" role="group">
                  {% if can_check %}
                    <a href="{% url 'edit_attendance' event.id %}" class="btn btn-sm btn-outline-primary" 
                       title="Edytuj wydarzenie">
                      ‚úèÔ∏è Edytuj
                    </a>
                  {% endif %}
                  {% if can_delete %}
                    <a href="{% url 'delete_attendance' event.id %}" class="btn btn-sm btn-outline-danger" 
                       title="Usu≈Ñ wydarzenie">
                      üóëÔ∏è Usu≈Ñ
                    </a>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for section in sectioned_attendance_grid %}
        {% if section.user_rows %}
          <tr class="table-secondary">
            <td colspan="{{ events|length|add:'1' }}" class="fw-bold text-center">
              {{ section.section_name }}
            </td>
          </tr>
          {% for user_row in section.user_rows %}
            <tr>
              <td class="fw-semibold text-start">{{ user_row.user.first_name }} {{ user_row.user.last_name }}</td>
              {% for attendance_data in user_row.attendances %}
                <td class="text-center">
                  {% if attendance_data.present %}
                    <span class="text-success fs-4">&#10003;</span>
                  {% elif attendance_data.present == False %}
                    <span class="text-danger fs-4">&#10007;</span>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        {% endif %}
      {% empty %}
        <tr>
          <td colspan="{{ events|length|add:'1' }}" class="text-center">Brak u≈ºytkownik√≥w.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<style>
/* Fixed width for user column */
.user-column {
  width: 200px;
  min-width: 200px;
  max-width: 200px;
}

/* Ensure user cells also maintain the width */
.table td:first-child {
  width: 200px;
  min-width: 200px;
  max-width: 200px;
}

/* Responsive table improvements */
@media (max-width: 768px) {
  .user-column {
    width: 150px;
    min-width: 150px;
    max-width: 150px;
  }
  
  .table td:first-child {
    width: 150px;
    min-width: 150px;
    max-width: 150px;
  }
  
  .table th {
    font-size: 0.875rem;
    padding: 0.5rem 0.25rem;
  }
  
  .btn-sm {
    font-size: 0.75rem;
    padding: 0.125rem 0.25rem;
  }
  
  .table-responsive {
    font-size: 0.875rem;
  }
}

/* Ensure table headers don't get too wide */
.table th:not(.user-column) {
  min-width: 120px;
  max-width: 180px;
}

/* Center content in table headers */
.table th .d-flex {
  min-height: 80px;
}
</style>
{% endblock %}
