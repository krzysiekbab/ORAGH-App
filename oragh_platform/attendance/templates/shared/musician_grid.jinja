{% comment %}
Musician grid component for selection
Parameters:
- sectioned_musicians: List of sections with musicians
- checkbox_prefix: Prefix for checkbox names (e.g., 'user_' for attendance, 'selected_musicians' for seasons)
- show_select_all: Boolean to show select all checkbox
- current_selections: Set of currently selected musician IDs (optional)
{% endcomment %}

<div class="card-header">
  <h5 class="mb-0">{{ header_title|default:'Muzycy' }}</h5>
  {% if event_type == 'rehearsal' %}
    <small class="text-muted">Dla próby: kliknij raz = obecny, kliknij ponownie = połowa, kliknij jeszcze raz = nieobecny</small>
  {% else %}
    <small class="text-muted">Kliknij aby zmienić obecność: nieobecny ↔ obecny</small>
  {% endif %}
</div>
<div class="card-body">
  {% for section in sectioned_musicians %}
    <div class="section-group mb-4">
      <h6 class="section-header">{{ section.section_name }}</h6>
      <div class="musicians-grid row g-2">
        {% for musician_data in section.musicians %}
          <div class="col-md-6 col-lg-4">
            <div class="musician-card" data-user-id="{% if edit_mode %}{{ musician_data.musician.user.id }}{% else %}{{ musician_data.user.id }}{% endif %}">
              <div class="musician-info">
                <span class="musician-name">{% if edit_mode %}{{ musician_data.musician.user.get_full_name }}{% else %}{{ musician_data.user.get_full_name }}{% endif %}</span>
              </div>
              
              <!-- Smart attendance button for all event types -->
              <div class="attendance-toggle" data-current-state="{% if edit_mode %}{{ musician_data.current_attendance }}{% else %}0.0{% endif %}">
                <input type="hidden" name="{{ checkbox_prefix }}{% if edit_mode %}{{ musician_data.musician.user.id }}{% else %}{{ musician_data.user.id }}{% endif %}" value="{% if edit_mode %}{{ musician_data.current_attendance }}{% else %}0.0{% endif %}" class="attendance-value">
                <button type="button" class="btn attendance-btn" 
                        data-state="{% if edit_mode %}{{ musician_data.current_attendance }}{% else %}0.0{% endif %}"
                        data-event-type="{{ event_type }}">
                  <span class="attendance-text">Nieobecny</span>
                  <span class="attendance-icon">❌</span>
                </button>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endfor %}
  
  {% if show_select_all %}
    <div class="mt-4">
      <div class="bulk-actions-container">
        <h6 class="bulk-actions-title">Akcje grupowe:</h6>
        <div class="bulk-actions-buttons">
          <button type="button" class="btn btn-success bulk-btn" onclick="setAllAttendance('1.0')">
            <span class="btn-icon">✅</span>
            <span class="btn-text">Wszyscy obecni</span>
          </button>
          {% if event_type == 'rehearsal' %}
          <button type="button" class="btn btn-warning bulk-btn" onclick="setAllAttendance('0.5')">
            <span class="btn-icon">☑️</span>
            <span class="btn-text">Wszyscy połowa</span>
          </button>
          {% endif %}
          <button type="button" class="btn btn-secondary bulk-btn" onclick="setAllAttendance('0.0')">
            <span class="btn-icon">❌</span>
            <span class="btn-text">Wszyscy nieobecni</span>
          </button>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const attendanceButtons = document.querySelectorAll('.attendance-btn');
    
    // Helper function to safely parse float with comma decimal separator
    function safeParseFloat(value) {
        if (typeof value === 'string') {
            // Replace comma with dot for proper parsing
            value = value.replace(',', '.');
        }
        return parseFloat(value) || 0.0;
    }
    
    attendanceButtons.forEach(button => {
        // Debug: log the initial state
        console.log('Initial button state:', button.dataset.state, typeof button.dataset.state);
        
        // Initialize the button display first
        updateButtonDisplay(button);
        
        button.addEventListener('click', function() {
            const currentState = safeParseFloat(this.dataset.state);
            const eventType = this.dataset.eventType;
            let newState;
            
            if (eventType === 'rehearsal') {
                // Cycle through states: 0.0 -> 1.0 -> 0.5 -> 0.0
                if (currentState === 0.0) {
                    newState = 1.0;
                } else if (currentState === 1.0) {
                    newState = 0.5;
                } else {
                    newState = 0.0;
                }
            } else {
                // For concerts and soundchecks: 0.0 -> 1.0 -> 0.0
                if (currentState === 0.0) {
                    newState = 1.0;
                } else {
                    newState = 0.0;
                }
            }
            
            this.dataset.state = newState.toString();
            const hiddenInput = this.parentElement.querySelector('.attendance-value');
            hiddenInput.value = newState.toString();
            
            updateButtonDisplay(this);
        });
    });
    
    function updateButtonDisplay(button) {
        const stateStr = button.dataset.state;
        const state = safeParseFloat(stateStr);
        const textSpan = button.querySelector('.attendance-text');
        const iconSpan = button.querySelector('.attendance-icon');
        
        // Debug: log the state being processed
        console.log('Updating button with state string:', stateStr, 'parsed as:', state);
        
        // Reset all classes
        button.className = 'btn attendance-btn';
        
        // Use precise decimal comparison
        if (state === 1.0) {
            button.classList.add('btn-success');
            textSpan.textContent = 'Obecny';
            iconSpan.textContent = '✅';
            console.log('Set to: Obecny');
        } else if (Math.abs(state - 0.5) < 0.001) {
            button.classList.add('btn-warning');
            textSpan.textContent = 'Połowa';
            iconSpan.textContent = '☑️';
            console.log('Set to: Połowa');
        } else {
            button.classList.add('btn-secondary');
            textSpan.textContent = 'Nieobecny';
            iconSpan.textContent = '❌';
            console.log('Set to: Nieobecny');
        }
    }
    
    // Make updateButtonDisplay available globally for setAllAttendance function
    window.updateButtonDisplay = updateButtonDisplay;
    window.safeParseFloat = safeParseFloat;
});

{% if show_select_all %}
function setAllAttendance(state) {
    const attendanceButtons = document.querySelectorAll('.attendance-btn');
    
    attendanceButtons.forEach(button => {
        button.dataset.state = state;
        const hiddenInput = button.parentElement.querySelector('.attendance-value');
        hiddenInput.value = state;
        
        updateButtonDisplay(button);
    });
}
{% endif %}
</script>

<style>
.section-group {
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 1rem;
}

.section-header {
    color: #495057;
    font-weight: 600;
    margin-bottom: 0.75rem;
    padding-bottom: 0.25rem;
    border-bottom: 2px solid #007bff;
}

.musician-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background-color: #f8f9fa;
}

.musician-info {
    display: flex;
    flex-direction: column;
}

.musician-name {
    font-weight: 500;
    color: #495057;
}

.attendance-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    min-width: 110px;
    justify-content: center;
    transition: all 0.2s ease;
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
}

.attendance-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.attendance-icon {
    font-size: 1.1em;
}

/* Bulk actions styling */
.bulk-actions-container {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 1rem;
}

.bulk-actions-title {
    color: #495057;
    margin-bottom: 0.75rem;
    font-size: 0.875rem;
    font-weight: 600;
}

.bulk-actions-buttons {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.bulk-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
    min-width: 140px;
    justify-content: center;
}

.bulk-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.bulk-btn .btn-icon {
    font-size: 1.1em;
}

.bulk-btn .btn-text {
    white-space: nowrap;
}

/* Mobile responsive improvements */
@media (max-width: 768px) {
    .musician-card {
        /* Keep flex-direction: row for mobile to show button next to name */
        flex-direction: row;
        align-items: center;
        padding: 0.5rem;
        gap: 0.5rem;
    }
    
    .musician-info {
        flex: 1;
        min-width: 0; /* Allow text to truncate */
    }
    
    .musician-name {
        font-size: 0.875rem;
        line-height: 1.2;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .attendance-btn {
        min-width: 100px;
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        flex-shrink: 0;
        gap: 0.25rem;
    }
    
    .attendance-btn .attendance-text {
        font-size: 0.7rem;
        line-height: 1.1;
    }
    
    .attendance-btn .attendance-icon {
        font-size: 1.1em;
    }
    
    /* Bulk actions mobile layout */
    .bulk-actions-buttons {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .bulk-btn {
        width: 100%;
        min-width: auto;
        padding: 0.75rem;
        font-size: 0.875rem;
    }
    
    .bulk-actions-title {
        text-align: center;
        margin-bottom: 1rem;
    }
}

/* Extra small screens */
@media (max-width: 576px) {
    .musicians-grid {
        margin: 0 -0.25rem;
    }
    
    .musicians-grid .col-md-6 {
        padding: 0 0.25rem;
    }
    
    .musician-card {
        padding: 0.375rem;
    }
    
    .attendance-btn {
        min-width: 90px;
        padding: 0.2rem 0.4rem;
        font-size: 0.65rem;
        gap: 0.2rem;
    }
    
    .attendance-btn .attendance-text {
        font-size: 0.6rem;
    }
    
    .attendance-btn .attendance-icon {
        font-size: 1.0em;
    }
}
</style>
